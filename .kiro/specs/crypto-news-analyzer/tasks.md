# 实现计划: 加密货币新闻分析工具

## 概述

基于Python实现的模块化加密货币新闻爬取和分析系统，支持RSS、X/Twitter多源数据收集，LLM智能分析，以及Telegram自动报告发送。

## 任务

- [x] 1. 建立项目结构和核心配置系统
  - 创建Python项目目录结构
  - 实现ConfigManager类用于配置文件管理
  - 创建默认配置文件模板
  - 设置日志系统和错误处理框架
  - _需求: 1.1, 1.8, 2.1, 2.5, 2.6_

- [x] 2. 实现数据模型和存储系统
  - [x] 2.1 创建核心数据模型类
    - 实现ContentItem、RSSSource、XSource等数据类
    - 创建AnalysisResult和CrawlResult数据结构
    - 实现数据验证和序列化方法
    - _需求: 2.2, 2.3, 2.4_
  
  - [x] 2.2 为数据模型编写属性测试
    - **属性 2: 配置持久化一致性**
    - **验证: 需求 1.8**
  
  - [x] 2.3 实现SQLite数据存储系统
    - 创建DataManager类和数据库schema
    - 实现数据去重、时间过滤和清理机制
    - 添加数据库连接池和事务管理
    - _需求: 2.10, 10.1_
  
  - [x] 2.4 为数据存储编写属性测试
    - **属性 16: 时间窗口过滤正确性**
    - **验证: 需求 10.1**

- [x] 3. 检查点 - 确保核心基础设施正常工作
  - 确保所有测试通过，如有问题请询问用户。

- [x] 4. 实现RSS爬取功能
  - [x] 4.1 创建RSS爬取器
    - 使用feedparser库实现RSSCrawler类
    - 支持多种RSS格式解析和错误处理
    - 实现时间窗口过滤和内容提取
    - _需求: 3.1, 3.2, 3.4, 3.5_
  
  - [x] 4.2 为RSS爬取编写属性测试
    - **属性 10: 内容解析完整性**
    - **验证: 需求 3.4**
  
  - [x] 4.3 编写RSS爬取单元测试
    - 测试各种RSS格式的解析
    - 测试网络错误和异常情况
    - _需求: 3.3, 3.6_

- [x] 5. 实现X/Twitter爬取功能（通过bird工具）
  - [x] 5.1 安装和配置bird工具依赖
    - 验证bird工具的安装和可用性
    - 创建BirdDependencyManager类管理依赖检查
    - 实现bird工具版本兼容性验证
    - 提供安装指导和错误诊断信息
    - _需求: 4.3, 4.11_
  
  - [x] 5.2 创建bird工具Python封装层
    - 实现BirdWrapper类封装命令行调用
    - 支持从环境变量读取X/Twitter认证信息
    - 实现命令执行、超时控制和输出解析
    - 添加bird工具配置文件管理
    - _需求: 4.4, 4.5, 4.12_
  
  - [x] 5.3 实现基于bird工具的X爬取器
    - 重构XCrawler类，基于BirdWrapper实现
    - 实现列表和时间线爬取功能
    - 添加bird工具输出解析和数据提取
    - 实现时间窗口过滤和内容标准化
    - _需求: 4.1, 4.2, 4.7, 4.8_
  
  - [x] 5.4 实现Bird智能速率限制策略
    - 在DataManager中添加get_latest_message_time方法，查询指定源的最近消息时间
    - 在BirdWrapper中实现calculate_max_pages_for_source方法
    - 实现时间差计算逻辑（使用UTC时区）
    - 实现max_pages计算公式：min(ceil(时间差/6小时), max_pages_limit)
    - 处理无历史数据的情况，使用max_pages_limit作为默认值
    - 在fetch_list_tweets和fetch_user_timeline中集成max_pages计算
    - _需求: 4.13, 4.14, 4.15, 4.16, 4.17, 4.18, 4.19_
  
  - [ ] 5.5 为Bird智能速率限制编写属性测试
    - **属性 11.1: Bird智能速率限制正确性**
    - **验证: 需求 4.13, 4.14, 4.15, 4.16, 4.17, 4.19**
  
  - [x] 5.6 为bird工具集成编写属性测试
    - **属性 11: Bird工具集成一致性**
    - **验证: 需求 4.3, 4.6, 4.11**
  
  - [x] 5.7 编写X爬取单元测试
    - 测试bird工具调用和错误处理
    - 测试输出解析和数据提取逻辑
    - 测试依赖检查和配置验证
    - _需求: 4.6, 4.9, 4.10_

- [x] 6. 实现多步骤智能分析系统
  - [x] 6.1 实现市场快照获取服务
    - 创建MarketSnapshotService类，集成Grok等联网AI服务
    - 实现市场快照缓存和质量验证机制
    - 支持从环境变量读取GROK_API_KEY认证信息
    - 添加备用快照和错误处理机制
    - _需求: 5.1, 5.2, 5.3, 5.18_
  
  - [x] 6.2 实现结构化输出管理器
    - 创建StructuredOutputManager类，集成instructor等工具
    - 强制大模型返回标准JSON格式（time, category, weight_score, summary, source）
    - 实现输出格式验证和错误恢复机制
    - 支持多种结构化输出库的集成
    - _需求: 5.5, 5.13, 5.15_
  
  - [x] 6.3 重构LLM分析器支持四步分析流程
    - 重构LLMAnalyzer类，实现四步分析流程
    - 第一步：获取市场快照，第二步：合并提示词(注意市场快照中的超链接部分不要合并)
    - 第三步：结构化输出，第四步：批量分析
    - 支持动态分类，不硬编码具体类别
    - _需求: 5.4, 5.6, 5.7, 5.8, 5.9_
  
  - [x] 6.4 实现动态分类管理器
    - 创建DynamicClassificationManager类
    - 根据大模型返回结果自动发现和管理分类
    - 实现分类一致性验证和统计功能
    - 支持运行时分类变更和适应
    - _需求: 5.8, 5.9, 5.10_
  
  - [x] 6.5 为多步骤分析编写属性测试
    - **属性 5: 市场快照获取一致性**
    - **属性 6: 提示词合并正确性**
    - **属性 7: 结构化输出一致性**
    - **属性 8: 动态分类处理正确性**
    - **属性 9: 批量分析完整性**
    - **验证: 需求 5.1-5.18**
  
  - [x] 6.6 编写多步骤分析单元测试
    - 测试市场快照获取和缓存机制
    - 测试结构化输出和格式验证
    - 测试动态分类发现和管理
    - 测试批量分析和去重功能
    - _需求: 5.11, 5.12, 5.14, 5.16, 5.17_

- [x] 7. 检查点 - 确保数据收集和分析功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [x] 8. 实现Telegram适配的报告生成和发送系统
  - [x] 8.1 创建Telegram格式化器
    - 实现TelegramFormatter类，适配Telegram消息格式
    - 支持Telegram特殊字符转义和格式化语法
    - 实现超链接格式化和移动端优化
    - 添加长消息分割和格式保持功能
    - _需求: 7.1, 7.10, 7.12, 7.13, 7.15, 7.17_
  
  - [x] 8.2 重构报告生成器支持动态分类和市场快照
    - 重构ReportGenerator类，生成Telegram适配的报告
    - 支持动态分类展示，根据大模型返回结果调整结构
    - 集成市场快照部分，显示实时市场信息
    - 实现source字段的Telegram超链接转换
    - _需求: 7.2, 7.4, 7.5, 7.7, 7.8, 7.9, 7.11, 7.14_
  
  - [x] 8.3 为Telegram报告生成编写属性测试
    - **属性 12: Telegram格式适配正确性**
    - **属性 13: 动态分类展示一致性**
    - **验证: 需求 7.1-7.18**
  
  - [x] 8.4 保持现有Telegram发送器功能
    - 确保TelegramSender类继续支持Bot API
    - 维持长消息分割和发送状态验证
    - 保持错误处理和重试机制
    - _需求: 8.1, 8.2, 8.3, 8.4_
  
  - [ ]* 8.5 编写Telegram报告系统单元测试
    - 测试Telegram格式化和字符转义
    - 测试动态分类展示和空分类处理
    - 测试市场快照集成和超链接格式化
    - 测试移动端显示优化
    - _需求: 7.16, 7.18, 8.5, 8.6, 8.7_

- [-] 9. 实现扩展性支持和插件系统
  - [x] 9.1 创建数据源工厂和插件接口
    - 实现DataSourceFactory和DataSourceInterface
    - 创建RESTAPICrawler作为扩展示例
    - 支持动态注册和配置新数据源
    - _需求: 扩展性要求_
  
  - [x] 9.2 为插件系统编写属性测试
    - **属性 3: 配置文件管理**
    - **验证: 需求 2.1, 2.5, 2.8, 2.13**
  
  - [x] 9.3 编写扩展性单元测试
    - 测试新数据源的注册和使用
    - 测试配置文件的动态更新
    - _需求: 扩展性要求_

- [ ] 10. 实现Docker化部署和内部定时调度
  - [x] 10.1 创建主控制器支持一次性执行模式和内部调度
    - 编写MainController类，支持一次性执行完整工作流
    - 实现内部定时调度器，支持程序内部的周期性任务执行
    - 支持通过配置文件或环境变量设置调度间隔
    - 实现执行完成后自动退出机制和持续运行模式
    - 添加完整的错误恢复和资源清理机制
    - _需求: 9.1, 9.2, 9.3, 9.8, 9.9, 9.15, 9.19, 9.20_
  
  - [x] 10.2 创建Dockerfile和容器配置
    - 编写Dockerfile将项目完整打包成Docker容器
    - 配置非root用户运行和安全最佳实践
    - 实现环境变量配置管理和验证
    - 优化镜像大小和启动时间
    - _需求: 9.4, 9.10, 9.14, 9.16_
  
  - [ ] 10.3 创建docker-compose.yml配置文件
    - 编写docker-compose.yml支持容器启动和管理
    - 配置数据卷挂载（配置、日志、数据）
    - 确保bird工具在容器中正确安装和配置
    - 支持`docker-compose run --rm my-service`命令执行一次性任务
    - 支持`docker-compose up -d my-service`命令启动持续运行的定时调度模式
    - 实现容器健康检查机制
    - _需求: 9.5, 9.6, 9.7, 9.11, 9.12_
  
  - [ ] 10.4 实现容器信号处理和状态管理
    - 实现优雅停止机制，处理SIGTERM和SIGINT信号
    - 添加容器启动时的配置验证和快速失败机制
    - 实现退出状态码管理（0=成功，非0=失败）
    - 配置容器日志标准输出
    - 记录每次执行的开始时间、结束时间和执行状态
    - 实现定时任务执行失败时的错误处理和重试机制
    - _需求: 9.13, 9.15, 9.17, 9.18, 9.19, 9.20_
  
  - [ ]* 10.5 为主控制器编写属性测试
    - **属性 17: 容错处理一致性**
    - **验证: 需求 11.1**

- [ ] 11. 实现Telegram命令触发功能
  - [ ] 11.1 创建Telegram命令处理器
    - 实现TelegramCommandHandler类，支持命令解析和权限验证
    - 实现/run、/status、/help命令的处理逻辑
    - 添加授权用户管理和权限验证机制
    - 实现命令执行历史记录和日志管理
    - _需求: 16.1, 16.2, 16.3, 16.4, 16.5, 16.8, 16.10, 16.11_
  
  - [ ] 11.2 集成命令触发与执行协调器
    - 扩展ExecutionCoordinator支持手动触发执行
    - 实现并发控制，防止多个执行同时进行
    - 添加执行超时管理和状态查询功能
    - 实现执行完成后的用户通知机制
    - _需求: 16.6, 16.7, 16.9, 16.14, 16.15_
  
  - [ ] 11.3 为Telegram命令功能编写属性测试
    - **属性 18: 命令权限验证一致性**
    - **验证: 需求 16.5, 16.10, 16.11**
  
  - [ ]* 11.4 编写Telegram命令单元测试
    - 测试命令解析和权限验证逻辑
    - 测试各种命令场景和错误处理
    - 测试并发控制和超时机制
    - _需求: 16.12, 16.13_

- [ ] 12. 创建部署配置和示例文件
- [ ] 12. 创建部署配置和示例文件
  - [ ] 12.1 创建部署配置和示例文件
    - 创建requirements.txt和setup.py
    - 提供Docker部署示例和最佳实践文档
    - 添加bird工具安装和配置指南
    - 创建内部定时调度配置示例和使用说明
    - 添加Telegram命令功能的配置示例和权限管理说明
    - 提供docker-compose运行示例和配置模板（一次性执行、持续调度和命令监听三种模式）
    - _需求: 9.4, 9.5, 9.6, 9.16, 16.10_

- [ ] 13. 最终集成测试和文档
  - [ ]* 13.1 编写端到端集成测试
    - 测试完整的工作流程（配置→爬取→分析→报告→发送）
    - 测试bird工具集成和X/Twitter数据获取
    - 测试容器化部署和一次性执行模式
    - 测试Docker Compose运行和内部定时调度
    - 测试Telegram命令触发和权限验证
    - 测试容器信号处理和优雅退出机制
    - _需求: 所有需求_
  
  - [ ] 13.2 创建用户文档和示例
    - 编写README.md和安装指南
    - 创建配置示例和最佳实践文档
    - 添加bird工具安装和配置说明
    - 添加Telegram命令使用指南和权限配置说明
    - 添加故障排除和FAQ文档
    - _需求: 用户体验_

- [ ] 14. 最终检查点 - 确保系统完整可用
  - 确保所有测试通过，系统可以正常部署和运行，如有问题请询问用户。

## 注意事项

- 标记为 `*` 的任务为可选任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求条目以确保可追溯性
- 检查点任务确保增量验证和早期问题发现
- 属性测试使用Hypothesis库，每个测试至少运行100次迭代
- 单元测试使用pytest框架，目标覆盖率85%以上