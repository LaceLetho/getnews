# Telegram 命令触发功能使用指南

## 概述

系统支持通过Telegram Bot命令手动触发执行，同时不影响定时调度任务。两种触发方式共享并发控制机制，确保不会发生冲突。

## 工作原理

### 混合模式运行

当系统以 `schedule` 模式启动时：

1. **定时调度器**：按配置的间隔（如每小时）自动执行任务
2. **命令监听器**：同时监听Telegram命令，响应用户的手动触发请求
3. **并发控制**：确保同一时间只有一个执行在进行

```
┌─────────────────────────────────────────────────────────┐
│                    系统运行状态                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐              ┌──────────────┐        │
│  │ 定时调度器    │              │ 命令监听器    │        │
│  │ (每小时触发)  │              │ (实时监听)    │        │
│  └──────┬───────┘              └──────┬───────┘        │
│         │                             │                 │
│         └─────────┬───────────────────┘                 │
│                   │                                     │
│                   ▼                                     │
│         ┌─────────────────┐                            │
│         │  并发控制机制    │                            │
│         │ (同时只执行一个) │                            │
│         └─────────┬───────┘                            │
│                   │                                     │
│                   ▼                                     │
│         ┌─────────────────┐                            │
│         │   执行工作流     │                            │
│         │ 爬取→分析→报告   │                            │
│         └─────────────────┘                            │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 并发控制机制

- 如果定时任务正在执行，命令触发会被拒绝
- 如果命令触发的任务正在执行，定时任务会跳过本次调度
- 执行完成后，两种触发方式都可以再次触发

## 配置步骤

### 1. 获取Telegram User ID

1. 在Telegram中搜索 `@userinfobot`
2. 发送 `/start` 命令
3. Bot会返回你的User ID（如：`123456789`）

### 2. 配置授权用户

编辑 `config.json`，添加或修改 `telegram_commands` 部分：

```json
{
  "telegram_commands": {
    "enabled": true,
    "authorized_users": [
      {
        "user_id": "123456789",
        "username": "your_telegram_username",
        "permissions": ["run", "status", "help"]
      }
    ],
    "execution_timeout_minutes": 30,
    "max_concurrent_executions": 1,
    "command_rate_limit": {
      "max_commands_per_hour": 10,
      "cooldown_minutes": 5
    }
  }
}
```

### 3. 配置说明

#### `enabled`
- `true`: 启用命令触发功能
- `false`: 禁用命令触发功能（仅运行定时调度）

#### `authorized_users`
授权用户列表，每个用户包含：
- `user_id`: Telegram用户ID（必需）
- `username`: Telegram用户名（可选，用于日志记录）
- `permissions`: 允许的命令列表
  - `["run", "status", "help"]`: 允许所有命令
  - `["status", "help"]`: 只允许查询状态和帮助
  - `[]`: 空列表表示允许所有命令

#### `execution_timeout_minutes`
手动触发的执行超时时间（分钟）

#### `max_concurrent_executions`
最大并发执行数（建议保持为1）

#### `command_rate_limit`
速率限制配置：
- `max_commands_per_hour`: 每小时最多命令数
- `cooldown_minutes`: 命令冷却时间（分钟）

## 可用命令

### `/run` - 立即执行

触发一次完整的数据收集和分析任务。

**示例**：
```
用户: /run
Bot: 🚀 开始执行

系统已开始执行数据收集和分析任务。
执行完成后将自动发送报告。
```

**执行完成后**：
```
Bot: ✅ 执行完成

执行ID: exec_1234567890
处理项目: 150
耗时: 45.2 秒
报告发送: 成功

报告已发送到频道。
```

**如果系统正忙**：
```
Bot: ⏳ 执行中

系统正在执行任务，请稍后再试。

执行ID: exec_1234567890
当前阶段: analyzing
进度: 65.0%
```

### `/status` - 查询状态

查询系统当前运行状态和最近执行结果。

**示例**：
```
用户: /status
Bot: 📊 系统状态

当前执行: 无

系统信息:
初始化: 是
调度器: 运行中
历史执行: 42 次

最近执行:
时间: 2026-02-09 14:30:00
结果: ✅ 成功
处理项目: 150
耗时: 45.2 秒
```

### `/help` - 帮助信息

显示可用命令列表和使用说明。

**示例**：
```
用户: /help
Bot: 🤖 加密货币新闻分析机器人

可用命令:

/run - 立即执行一次数据收集和分析
触发完整的工作流程，包括数据爬取、内容分析和报告生成。

/status - 查询系统运行状态
显示当前执行状态、系统信息和最近执行结果。

/help - 显示此帮助信息
查看所有可用命令和使用说明。

注意事项:
• 命令有速率限制，请勿频繁调用
• 执行过程可能需要几分钟时间
• 执行完成后会自动发送报告
```

## 权限管理

### 添加多个授权用户

```json
{
  "telegram_commands": {
    "enabled": true,
    "authorized_users": [
      {
        "user_id": "123456789",
        "username": "admin_user",
        "permissions": ["run", "status", "help"]
      },
      {
        "user_id": "987654321",
        "username": "viewer_user",
        "permissions": ["status", "help"]
      }
    ]
  }
}
```

### 权限级别说明

1. **完全权限**：`["run", "status", "help"]`
   - 可以触发执行、查询状态、查看帮助

2. **只读权限**：`["status", "help"]`
   - 只能查询状态和查看帮助，不能触发执行

3. **所有权限**：`[]`（空列表）
   - 允许所有命令（等同于完全权限）

### 权限验证流程

```
用户发送命令
    ↓
检查用户是否在授权列表中
    ↓
    ├─ 否 → 返回权限拒绝消息
    ↓
    └─ 是 → 检查用户是否有该命令权限
              ↓
              ├─ 否 → 返回权限不足消息
              ↓
              └─ 是 → 检查速率限制
                      ↓
                      ├─ 超限 → 返回速率限制消息
                      ↓
                      └─ 通过 → 执行命令
```

## 速率限制

### 默认限制

- **每小时最多10次命令**
- **命令冷却时间5分钟**

### 超出限制时的响应

```
Bot: ⏱️ 速率限制

已达到每小时命令限制 (10 次)，请稍后再试
```

或

```
Bot: ⏱️ 速率限制

命令冷却中，请等待 3.5 分钟
```

### 调整速率限制

编辑 `config.json`：

```json
{
  "telegram_commands": {
    "command_rate_limit": {
      "max_commands_per_hour": 20,
      "cooldown_minutes": 3
    }
  }
}
```

## 故障排查

### 命令无响应

1. **检查Bot Token是否正确**
   ```bash
   echo $TELEGRAM_BOT_TOKEN
   ```

2. **检查命令监听器是否启动**
   查看日志：
   ```
   [INFO] Telegram命令监听器已启动
   ```

3. **检查用户是否授权**
   确认你的User ID在 `authorized_users` 列表中

### 权限被拒绝

1. **确认User ID正确**
   - 使用 `@userinfobot` 获取正确的User ID
   - 注意User ID是数字，不是用户名

2. **检查配置文件**
   ```json
   {
     "telegram_commands": {
       "enabled": true,
       "authorized_users": [
         {
           "user_id": "你的User ID",
           "permissions": ["run", "status", "help"]
         }
       ]
     }
   }
   ```

3. **重启服务**
   配置更改后需要重启服务才能生效

### 执行失败

查看Bot返回的错误信息：

```
Bot: ❌ 执行失败

执行ID: exec_1234567890
耗时: 5.0 秒

错误信息:
系统正在执行任务，请稍后再试
```

常见错误：
- **系统正在执行任务**：等待当前任务完成
- **配置验证失败**：检查环境变量和配置文件
- **API调用失败**：检查API密钥是否有效

## 日志记录

所有命令执行都会被记录：

```
[INFO] 收到/run命令，用户: admin_user (123456789)
[INFO] 用户 123456789 触发手动执行
[INFO] 开始执行工作流 exec_1234567890
[INFO] 工作流执行完成 exec_1234567890: 成功
[INFO] 命令执行记录: /run by admin_user (123456789), success=True, execution_id=exec_1234567890
```

## 最佳实践

1. **限制授权用户数量**
   - 只授权必要的用户
   - 定期审查授权列表

2. **合理设置速率限制**
   - 防止命令滥用
   - 避免过度频繁的执行

3. **使用权限分级**
   - 管理员：完全权限
   - 普通用户：只读权限

4. **监控命令使用情况**
   - 定期检查日志
   - 关注异常的命令模式

5. **保护Bot Token**
   - 不要在公开场所分享
   - 使用环境变量存储
   - 定期更换Token

## 安全建议

1. **User ID验证**
   - 使用User ID而不是用户名进行授权
   - User ID不会改变，更安全

2. **速率限制**
   - 防止暴力攻击
   - 限制资源消耗

3. **命令日志**
   - 记录所有命令执行
   - 便于审计和追踪

4. **权限最小化**
   - 只授予必要的权限
   - 定期审查权限配置

## 与定时调度的协同

### 场景1：定时任务正在执行

```
14:00 - 定时任务开始执行
14:05 - 用户发送 /run 命令
       → Bot返回：系统正在执行任务，请稍后再试
14:10 - 定时任务完成
14:11 - 用户再次发送 /run 命令
       → Bot开始执行
```

### 场景2：命令触发的任务正在执行

```
14:00 - 用户发送 /run 命令，开始执行
14:05 - 定时调度器触发（每小时一次）
       → 检测到任务正在执行，跳过本次调度
14:10 - 命令触发的任务完成
15:00 - 定时调度器再次触发
       → 正常执行
```

### 场景3：正常协同工作

```
13:00 - 定时任务执行（耗时5分钟）
13:05 - 定时任务完成
14:00 - 定时任务执行（耗时5分钟）
14:05 - 定时任务完成
14:30 - 用户发送 /run 命令（耗时5分钟）
14:35 - 命令触发的任务完成
15:00 - 定时任务执行（耗时5分钟）
15:05 - 定时任务完成
```

## 总结

Telegram命令触发功能提供了灵活的手动控制方式，同时保持与定时调度的和谐共存。通过合理的配置和使用，可以大大提升系统的可用性和便利性。
