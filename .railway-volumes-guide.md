# Railway Volumes 快速指南

## 已配置的 Volumes

```toml
[[deploy.volumes]]
name = "data"
mountPath = "/app/data"

[[deploy.volumes]]
name = "logs"
mountPath = "/app/logs"
```

## 存储内容

### `/app/data` Volume
- `crypto_news.db` - SQLite 数据库（新闻、分析结果）
- `cache/market_snapshot.json` - 市场快照缓存（30分钟TTL）

### `/app/logs` Volume
- `crypto_news_analyzer.log` - 应用运行日志
- 其他日志文件

## 部署步骤

1. **提交配置**
   ```bash
   git add railway.toml RAILWAY_DEPLOYMENT.md
   git commit -m "feat: 添加Railway volumes持久化存储"
   git push
   ```

2. **Railway 自动处理**
   - 检测到 `railway.toml` 中的 volumes 配置
   - 自动创建两个 volumes
   - 挂载到容器的指定路径
   - 容器重启时自动重新挂载

3. **验证存储**
   部署成功后，在 Railway 控制台：
   - 进入服务 → "Volumes" 标签
   - 应该看到 `data` 和 `logs` 两个 volumes
   - 查看使用情况和大小

## 常用操作

### 查看数据库内容
```bash
railway run sqlite3 /app/data/crypto_news.db "SELECT COUNT(*) FROM news;"
```

### 查看日志
```bash
railway run tail -f /app/logs/crypto_news_analyzer.log
```

### 下载备份
```bash
# 备份数据库
railway run cat /app/data/crypto_news.db > backup.db

# 或使用 Railway CLI（如果支持）
railway volume download data ./local-backup/
```

### 清理空间
```bash
# 连接到容器
railway run bash

# 查看空间使用
du -sh /app/data/*
du -sh /app/logs/*

# 清理旧日志（保留最近7天）
find /app/logs/ -name "*.log" -mtime +7 -delete
```

## 容量管理

### 免费计划限制
- 1GB volume 空间
- 超出部分按量计费

### 应用自动清理
配置在 `config.json`：
```json
{
  "storage": {
    "retention_days": 30,
    "max_storage_mb": 1000,
    "cleanup_frequency": "daily"
  }
}
```

### 手动调整保留期
如果空间不足，可以减少保留天数：
```bash
# 在 Railway 环境变量中设置（如果应用支持）
RETENTION_DAYS=7
```

或修改 `config.json` 后重新部署。

## 故障排查

### Volume 未创建
- 检查 `railway.toml` 语法是否正确
- 确认已推送到 Railway 连接的分支
- 查看部署日志是否有错误

### 数据丢失
- 确认 volume 配置在数据写入前已生效
- 检查 Railway 控制台 volumes 是否存在
- 旧部署的数据不会自动迁移到新 volume

### 空间不足
- 在 Railway 控制台查看 volume 使用情况
- 减少 `retention_days` 配置
- 手动清理旧数据
- 考虑升级 Railway 计划

## 最佳实践

1. **定期备份**：重要数据定期下载备份
2. **监控容量**：设置告警避免超出配额
3. **合理保留**：根据实际需求调整 `retention_days`
4. **日志轮转**：避免日志文件无限增长
