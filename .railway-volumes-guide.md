# Railway Volumes 快速指南

## 重要提示

⚠️ **Railway Volumes 必须在控制台手动创建，不能通过配置文件创建**

⚠️ **每个服务目前只能挂载一个 Volume**

## 创建 Volume 步骤

### 方法 1：使用命令面板（推荐）

1. 打开 Railway 项目控制台
2. 按 `⌘K`（Mac）或 `Ctrl+K`（Windows/Linux）
3. 输入 "New Volume" 并选择
4. 选择你的服务
5. 设置 Mount Path: `/app/data`
6. 点击 "Add" 创建

### 方法 2：右键菜单

1. 在项目画布空白处右键点击
2. 选择 "New Volume"
3. 选择你的服务
4. 设置 Mount Path: `/app/data`
5. 点击 "Add" 创建

## 推荐配置

由于单 Volume 限制，**只创建数据库 volume**：

```
Mount Path: /app/data
```

这个 volume 会存储：
- `crypto_news.db` - SQLite 数据库
- `cache/` - 市场快照缓存

日志可以通过 Railway 控制台查看，不需要持久化。

## 存储内容

### `/app/data` Volume（推荐创建）
- `crypto_news.db` - SQLite 数据库（新闻、分析结果）
- `cache/market_snapshot.json` - 市场快照缓存（30分钟TTL）

### `/app/logs`（不需要 Volume）
- 日志通过 Railway 控制台查看：Deployments → Logs
- 实时日志流，无需持久化存储

## 验证 Volume

创建后验证：

1. **查看 Volume**
   - 在项目画布上应该看到一个 Volume 图标
   - 点击查看详情和使用情况

2. **检查环境变量**
   ```bash
   railway run env | grep RAILWAY_VOLUME
   ```
   
   应该看到：
   ```
   RAILWAY_VOLUME_NAME=...
   RAILWAY_VOLUME_MOUNT_PATH=/app/data
   ```

3. **测试写入**
   ```bash
   railway run touch /app/data/test.txt
   railway run ls -la /app/data/
   ```

## 常用操作

### 查看数据库内容
```bash
railway run sqlite3 /app/data/crypto_news.db "SELECT COUNT(*) FROM news;"
```

### 查看日志
```bash
railway run tail -f /app/logs/crypto_news_analyzer.log
```

### 下载备份
```bash
# 备份数据库
railway run cat /app/data/crypto_news.db > backup.db

# 或使用 Railway CLI（如果支持）
railway volume download data ./local-backup/
```

### 清理空间
```bash
# 连接到容器
railway run bash

# 查看空间使用
du -sh /app/data/*
du -sh /app/logs/*

# 清理旧日志（保留最近7天）
find /app/logs/ -name "*.log" -mtime +7 -delete
```

## 容量管理

### 免费计划限制
- 1GB volume 空间
- 超出部分按量计费

### 应用自动清理
配置在 `config.json`：
```json
{
  "storage": {
    "retention_days": 30,
    "max_storage_mb": 1000,
    "cleanup_frequency": "daily"
  }
}
```

### 手动调整保留期
如果空间不足，可以减少保留天数：
```bash
# 在 Railway 环境变量中设置（如果应用支持）
RETENTION_DAYS=7
```

或修改 `config.json` 后重新部署。

## 故障排查

### Volume 未创建
- 检查 `railway.toml` 语法是否正确
- 确认已推送到 Railway 连接的分支
- 查看部署日志是否有错误

### 数据丢失
- 确认 volume 配置在数据写入前已生效
- 检查 Railway 控制台 volumes 是否存在
- 旧部署的数据不会自动迁移到新 volume

### 空间不足
- 在 Railway 控制台查看 volume 使用情况
- 减少 `retention_days` 配置
- 手动清理旧数据
- 考虑升级 Railway 计划

## 最佳实践

1. **定期备份**：重要数据定期下载备份
2. **监控容量**：设置告警避免超出配额
3. **合理保留**：根据实际需求调整 `retention_days`
4. **日志轮转**：避免日志文件无限增长
